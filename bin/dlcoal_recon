#!/usr/bin/env python
# DLCoal Reconciliation

import optparse
from rasmus.common import *
from compbio import birthdeath, dlcoal

o = optparse.OptionParser()
o.add_option("-s", "--stree", dest="stree", metavar="SPECIES_TREE")
o.add_option("-S", "--smap", dest="smap", metavar="GENE_TO_SPECIES_MAP")
o.add_option("-n", "--popsize", dest="popsize", metavar="POPULATION_SIZE",
             type="float")
o.add_option("-D", "--duprate", dest="duprate", metavar="DUPLICATION_RATE",
             type="float")
o.add_option("-L", "--lossrate", dest="lossrate", metavar="LOSS_RATE",
             type="float")
o.add_option("-g", "--gentime", dest="gentime", metavar="GENRATION_TIME",
             type="float")
o.add_option("-i", "--iter", dest="iter", metavar="ITERATIONS",
             type="int", default=100)
o.add_option("-I", "--inext", dest="inext", metavar="INPUT_EXT",
             default="")
o.add_option("-O", "--outext", dest="outext", metavar="OUTPUT_EXT",
             default="dlcoal")


conf, args = o.parse_args()


#=============================================================================

# read inputs
treefile = args[0]
stree = read_tree(conf.stree)
smap = phylo.read_gene2species(conf.smap)
coal_tree = read_tree(treefile)

for node in stree:
    node.dist *= 1e6 / conf.gentime
duprate = conf.duprate / (1e6 / conf.gentime)
lossrate = conf.lossrate / (1e6 / conf.gentime)

times = birthdeath.get_tree_timestamps(stree)

maxp, maxrecon = dlcoal.dlcoal_recon(
    coal_tree, stree, smap, conf.popsize, duprate, lossrate,
    premean=.5 * times[stree.root],
    nsamples=10,
    nsearch=conf.iter)

out = util.replace_ext(treefile, conf.inext, conf.outext)
dlcoal.write_dlcoal_recon(out, coal_tree, maxrecon)

